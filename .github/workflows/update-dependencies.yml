---
name: update-dependencies

on:
  schedule:
    - cron: '0 9 * * 1' # Weekly on Mondays at 9am UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-base-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository.
        uses: actions/checkout@v4

      - name: Set up Docker Buildx.
        uses: docker/setup-buildx-action@v3

      - name: Check for base image updates.
        id: check-updates
        run: |
          # Get current base images from Dockerfile
          BUILDER_IMAGE=$(grep "^FROM alpine:latest AS builder" Dockerfile | awk '{print $2}')
          RELEASE_IMAGE=$(grep "^FROM docker:.* AS release" Dockerfile | awk '{print $2}')

          echo "Current builder image: $BUILDER_IMAGE"
          echo "Current release image: $RELEASE_IMAGE"

          # Pull latest versions
          docker pull "$BUILDER_IMAGE" --quiet
          docker pull "$RELEASE_IMAGE" --quiet

          # Get digests
          BUILDER_DIGEST=$(docker inspect --format='{{.RepoDigests}}' "$BUILDER_IMAGE" | grep -oP 'sha256:[a-f0-9]{64}' | head -1)
          RELEASE_DIGEST=$(docker inspect --format='{{.RepoDigests}}' "$RELEASE_IMAGE" | grep -oP 'sha256:[a-f0-9]{64}' | head -1)

          echo "builder_digest=$BUILDER_DIGEST" >> $GITHUB_OUTPUT
          echo "release_digest=$RELEASE_DIGEST" >> $GITHUB_OUTPUT

          # Check if we need to rebuild
          if [ -z "$BUILDER_DIGEST" ] || [ -z "$RELEASE_DIGEST" ]; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Build test image.
        if: steps.check-updates.outputs.updates_available == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: test-image:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create Pull Request.
        if: steps.check-updates.outputs.updates_available == 'true'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update base image dependencies'
          title: 'chore(deps): update base image dependencies'
          body: |
            ## Automated Base Image Update

            This PR updates the base Docker images to their latest versions.

            ### Changes
            - Builder image digest: `${{ steps.check-updates.outputs.builder_digest }}`
            - Release image digest: `${{ steps.check-updates.outputs.release_digest }}`

            ### Testing
            - Build test completed successfully
            - Please review and test the updated images before merging

            ---
            *This PR was automatically generated by the update-dependencies workflow.*
          branch: chore/update-base-images
          delete-branch: true
          assignees: SimplicityGuy
          labels: dependencies,automated,docker

      - name: Send notification to Discord.
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
